# Discord → Obsidian インポーターBot プロジェクト仕様書

## プロジェクト概要

### 機能と目的
- **Discord投稿の自動変換**: Discordチャンネルに投稿されたメッセージを監視し、AIで整理・整形してObsidianメモとして自動保存
- **思考の記録支援**: 思いついたアイデアをDiscordに投稿するだけで、構造化された読みやすいメモが自動生成される
- **関連性分析**: 過去のメモとの関連性を自動分析し、Obsidianリンクを生成

### 使用技術スタック
- **Node.js 20** (メインランタイム)
- **discord.js v14** (Discord API連携)
- **OpenAI API** (GPT-4o-mini使用、AI整形処理)
- **Google Drive API** (ファイル保存・同期)
- **googleapis** (Google Drive連携)

### デプロイ環境
- **railway.app** (24時間稼働のクラウドホスティング)
- **Google Drive** (ファイル保存・Obsidian同期)

## 現在の技術構成

### アーキテクチャ
```
Discord → Bot監視 → OpenAI処理 → Google Drive保存（Obsidian Vault直接）
```

1. Discord Botがメッセージを監視
2. 投稿をOpenAI APIで整理・整形（URLのみの場合は要約処理）
3. Google Drive APIで直接Obsidian Vaultに保存
4. Obsidianでリアルタイム反映（同期不要）

### 使用API
- **Discord API**: メッセージ監視、リアクション応答
- **OpenAI API**: GPT-4o-mini（要約・整形・関連性分析）
- **Google Drive API**: Service Account認証でファイル操作

### 環境変数一覧
```
DISCORD_TOKEN=Discord Botトークン
OPENAI_API_KEY=OpenAI APIキー  
DISCORD_CHANNEL_ID=監視対象チャンネルID
GOOGLE_SERVICE_ACCOUNT_KEY=Service AccountのJSONキー（文字列）
GOOGLE_DRIVE_FOLDER_ID=通常メモ保存先Google DriveフォルダID
GOOGLE_DRIVE_URL_FOLDER_ID=URL要約保存先Google DriveフォルダID
```

### Google Drive連携の構成
- **Obsidian Vault**: Google Drive上に直接配置
- **保存先**: `Google Drive/Obsidian Vault/04_fromdicord_memo/`
- **同期**: 不要（Obsidian自体がGoogle Drive上で動作）
- **利点**: リアルタイム反映、設定シンプル、同期遅延なし

## 実装済み機能

### 動作確認済みの機能
✅ **Discord メッセージ監視**
- 指定チャンネルでの全メッセージ検知
- URLのみ投稿の自動判定・別処理
- Bot投稿の除外処理
- 重複処理防止（メッセージID管理）

✅ **URL専用処理機能**
- URLのみ投稿の自動判定
- WebFetch機能でページ内容取得・要約
- URL専用フォルダへの保存
- 🔗リアクションでの処理完了表示

✅ **AI整形処理**
- GPT-4o-miniによる高品質な文章整理
- **自然な日本語での整理・整形**
  - **体言止め**を積極活用
  - **だ・である調**は文脈に応じて自然に使用
  - 機械的な「である」付与を避け、読みやすさを重視
- 箇条書き形式での視認性向上
- 情報保持重視（要約ではなく整理・整形）

✅ **ファイル生成・保存**
- 日本時間ベースのファイル名生成: `YYYY-MM-DD_HH-MM-SS_トピック名.md`
- Google Drive APIでの確実な保存
- Markdown形式での構造化

✅ **関連性分析・リンク生成**
- 既存メモとの類似度判定（30%以上で関連認定）
- Obsidianリンク形式での関連メモ表示
- 最大3件までの関連メモ表示

✅ **Discord応答機能**
- 処理完了時の詳細応答（タイトル・コンテンツ・タグ・関連メモ表示）
- ✅/❌リアクションでの状態表示
- 箇条書きコンテンツの7項目まで表示制限

### 出力ファイル形式

#### 通常メッセージ用ファイル形式
**ファイル名**: `YYYY_MM-DD_HH-MM_トピック名.md`

**例**: `2025_06-15_19-30_トピック名.md`

**ファイル内容**:
```markdown
# トピック名

YYYY年MM月DD日HH時MM分作成

- [自然な日本語での内容1]
- [自然な日本語での内容2]
- [自然な日本語での内容3]
- [自然な日本語での内容4]

#タグ1 #タグ2 #タグ3 #タグ4

[[関連メモ1]]
[[関連メモ2]]
```

#### URL専用ファイル形式
**ファイル名**: `YYYY_MM-DD_HH-MM_ページ概要.md`

**例**: `2025_06-15_20-17_OpenAI最新情報.md`

**ファイル内容**:
```markdown
# ページ概要

YYYY年MM月DD日HH時MM分作成

- ページの主要内容を簡潔に要約1
- ページの主要内容を簡潔に要約2
- ページの主要内容を簡潔に要約3

URL: https://example.com

#タグ1 #タグ2 #タグ3
```

**重要**: 
- ファイル名にはタイムスタンプ付きだが、見出しはトピック名のみ
- URL専用は関連性分析を行わない（関連リンクなし）
- 別フォルダ（GOOGLE_DRIVE_URL_FOLDER_ID）に保存

### AI文末処理の改善ルール
1. **体言止め優先**: 「〜が存在」「〜に該当」「〜として機能」など
2. **自然なだ・である調**: 文脈上必要な場合のみ使用
3. **読みやすさ重視**: 機械的変換より自然な日本語を優先
4. **一文一項目**: 箇条書きの利点を活用

## 今後の課題・改善点

### パフォーマンス改善
- 大量メッセージ処理時の負荷分散
- OpenAI API呼び出し回数の最適化
- 関連性分析の効率化（キャッシュ機能）

### 機能拡張候補
- **多チャンネル対応**: 複数チャンネル同時監視
- **ユーザー別フィルタ**: 特定ユーザーのメッセージのみ処理
- **カスタムタグ**: ユーザー定義タグの自動付与
- **画像対応**: 添付画像の内容分析・保存
- **スケジュール機能**: 定期的な関連性再分析

## 特記事項
⚠️ **重要**: 作業中は作業日誌を書きながら進める（ユーザーは見ないため自由に記述可能）