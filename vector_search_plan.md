# ベクトル検索実装計画

## 背景・課題

### 現在の関連性分析の問題
- **高コスト**: 既存メモ数分のOpenAI API呼び出し（10個なら10回）
- **処理時間**: メモが増えるほど遅くなる
- **非効率**: 毎回全ファイルを読み込み・比較

### 現在の処理フロー
```
新メモ → 既存メモ1と比較（OpenAI API）
      → 既存メモ2と比較（OpenAI API）
      → 既存メモ3と比較（OpenAI API）
      → ...（メモ数分繰り返し）
```

## 解決方針：ベクトル検索導入

### 選択したソリューション
- **ChromaDB**: 軽量ベクトルDB、Node.js対応
- **railway.app**: ファイル永続化対応
- **OpenAI Embeddings**: ベクトル化API

### 新しい処理フロー
```
新メモ → OpenAI Embeddings（1回のみ）
      → ChromaDBでベクトル検索
      → 関連メモ発見
```

## 実装計画

### 1. 依存関係追加
```bash
npm install chromadb
```

### 2. 実装タスク
1. **ChromaDB初期化・設定**
2. **既存メモのベクトル化・保存**
3. **新メモでのベクトル検索機能**
4. **既存の関連性分析置き換え**
5. **環境変数・設定更新**

### 3. 期待する効果
- **コスト削減**: API呼び出し90%削減（10回→1回）
- **処理高速化**: ベクトル検索は数学計算のみ
- **スケーラビリティ**: メモ数が増えても処理時間一定

## 技術詳細

### ベクトル検索の仕組み
1. 新メモをOpenAI Embeddingsでベクトル化
2. ChromaDBで類似ベクトル検索
3. 類似度スコアで関連性判定
4. 上位3件を関連メモとして選択

### ファイル構成更新
- `vector_storage/`: ChromaDBデータ保存ディレクトリ
- 新関数: `initVectorDB()`, `addToVectorDB()`, `searchSimilar()`

## 実装完了項目

### ✅ 完了した作業
1. **ChromaDBインストール**: `npm install chromadb --no-bin-links`
2. **初期化関数**: `initVectorDB()` - コレクション作成
3. **ベクトル化関数**: `getEmbedding()` - OpenAI Embeddings使用
4. **追加関数**: `addToVectorDB()` - 新メモをベクトル化・保存
5. **検索関数**: `findRelatedNotes()` - ベクトル検索で関連メモ発見
6. **移行関数**: `migrateExistingMemos()` - 既存メモの一括移行

### 🔄 変更内容
- **API呼び出し削減**: 10回 → 1回（90%削減）
- **高速化**: ベクトル検索は数学計算のみ
- **スケーラビリティ**: メモ数増加に対応

### 🧪 テスト項目
1. 新メモ作成時のベクトル追加
2. 関連性検索の精度確認
3. railway.appでの永続化確認

## 次のステップ
1. ✅ 実装完了
2. 🔄 動作テスト
3. 📝 ドキュメント更新
4. 🚀 railway.appデプロイ

---
作成日: 2025年06月15日
プロジェクト: Discord → Obsidian インポーターBot