# 関連性検索改善計画：ベクトル検索 → キーワード検索

## 背景・課題

### 現在の関連性分析の問題
- **高コスト**: 既存メモ数分のOpenAI API呼び出し（10個なら10回）
- **処理時間**: メモが増えるほど遅くなる
- **非効率**: 毎回全ファイルを読み込み・比較

### 現在の処理フロー
```
新メモ → 既存メモ1と比較（OpenAI API）
      → 既存メモ2と比較（OpenAI API）
      → 既存メモ3と比較（OpenAI API）
      → ...（メモ数分繰り返し）
```

## 解決方針変更：キーワード検索採用

### 方針転換の理由
- **ChromaDBの複雑性**: サーバー設定、依存関係問題
- **即座に動作**: シンプルで確実
- **同等のコスト削減**: 10回 → 1回（90%削減）

### 採用したソリューション
- **キーワード抽出**: OpenAI APIで重要キーワード抽出
- **文字列マッチング**: ファイル名での関連性判定
- **シンプル実装**: 外部依存なし

### 新しい処理フロー
```
新メモ → OpenAI キーワード抽出（1回のみ）
      → ファイル名でキーワードマッチング
      → 関連メモ発見
```

## 実装計画

### 1. 依存関係追加
```bash
npm install chromadb
```

### 2. 実装タスク
1. **ChromaDB初期化・設定**
2. **既存メモのベクトル化・保存**
3. **新メモでのベクトル検索機能**
4. **既存の関連性分析置き換え**
5. **環境変数・設定更新**

### 3. 期待する効果
- **コスト削減**: API呼び出し90%削減（10回→1回）
- **処理高速化**: ベクトル検索は数学計算のみ
- **スケーラビリティ**: メモ数が増えても処理時間一定

## 技術詳細

### ベクトル検索の仕組み
1. 新メモをOpenAI Embeddingsでベクトル化
2. ChromaDBで類似ベクトル検索
3. 類似度スコアで関連性判定
4. 上位3件を関連メモとして選択

### ファイル構成更新
- `vector_storage/`: ChromaDBデータ保存ディレクトリ
- 新関数: `initVectorDB()`, `addToVectorDB()`, `searchSimilar()`

## 実装完了項目

### ✅ 完了した作業
1. **ChromaDB削除**: 複雑な依存関係を完全削除
2. **キーワード抽出関数**: `extractKeywords()` - OpenAI APIで重要キーワード抽出
3. **キーワード検索関数**: `findRelatedNotes()` - ファイル名マッチング
4. **シンプル関連性判定**: マッチ数による類似度計算
5. **クリーンアップ**: 不要コード削除、package.json整理

### 🔄 変更内容
- **API呼び出し削減**: 10回 → 1回（90%削減）
- **高速化**: 文字列マッチングのみ、外部DB不要
- **安定性**: 依存関係最小化、確実動作

### 🧪 テスト項目
1. キーワード抽出の精度確認
2. ファイル名マッチングの動作確認
3. railway.appでの動作確認

## キーワード検索の仕組み

### 処理詳細
1. **新メモからキーワード抽出**: OpenAI APIで5-8個の重要キーワード取得
2. **既存ファイル検索**: Google Driveから**全ファイル**取得（ページネーション対応）
3. **ファイル名マッチング**: キーワードがファイル名に含まれるかチェック
4. **類似度計算**: `マッチ数 / 総キーワード数`
5. **結果返却**: 上位3件を関連メモとして返却

### スケーラビリティ対応
- **ページネーション**: 1000件ずつGoogle Drive APIから取得
- **無制限対応**: 数千件・数万件でも全ファイル検索可能
- **進捗表示**: ページ取得状況をログ出力
- **エラー処理**: API制限やネットワークエラーにも対応

### メリット
- **即座に動作**: 外部DB不要
- **コスト効率**: OpenAI API 1回のみ
- **保守性**: シンプルな実装
- **拡張性**: 後でベクトル検索に移行可能

## 次のステップ
1. ✅ キーワード検索実装完了
2. 🧪 動作テスト
3. 📝 ドキュメント更新
4. 🚀 railway.appデプロイ

---
作成日: 2025年06月15日
プロジェクト: Discord → Obsidian インポーターBot